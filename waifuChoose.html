<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AniList Character Duel</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
    }
    #duel-container {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .character-card {
      text-align: center;
      border: 1px solid #ddd;
      padding: 10px;
      width: 150px;
      background-color: #333;
      color: white;
    }
    .character-card img {
      max-width: 100%;
    }
    #final-board {
      margin-top: 20px;
    }
    #status {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Anime Character Duel</h1>
  <p>It will look for the most popular characters. It will try to find roughly the count specified</p>
  <p>Choose your winner from each duel by pressing the left or right arrow key until only one remains! BTW WAIT A BIT FOR IT TO LOAD IF YOU CHOOSE A BIG NUMBER</p>
  
  <label for="characterCount">Number of characters:</label>
  <input type="number" id="characterCount" min="2" value="1000"> 
  <button id="startButton">Start Duel</button>

  
  <div id="status"></div>
  <div id="duel-container"></div>
  <div id="final-board"></div>

  <script>
    // Get references to the input and button elements
    const characterCountInput = document.getElementById('characterCount');
    const startButton = document.getElementById('startButton');


    let characters = [];
    let survivors = [];
    let currentDuel = [];
    let round = 1;

    const charactersPerPage = 50; // Number of characters to fetch per page
    const desiredCharacterCountt = parseInt(document.getElementById('characterCount').value) || 1000; // Default to 1000 if invalid input
    
    // Add an event listener to the button
    startButton.addEventListener('click',  
    () => {
          const desiredCharacterCount = parseInt(characterCountInput.value) || 1000;

          // Fetch characters and start the duel system
          fetchCharacters(desiredCharacterCountt); 
        });

        // Modify fetchCharacters to accept desiredCharacterCount as an argument
    async function fetchCharacters(desiredCharacterCount){
    let currentPage = 1;
    let totalCharactersFetched = 0;

    while (true) { // Keep fetching until we break explicitly
        const query = `
        query {
            Page(perPage: ${charactersPerPage}, page: ${currentPage}) {
            characters(sort: FAVOURITES_DESC) {
                name {
                full
                }
                image {
                large
                }
                gender
            }
            }
        }
        `;

        try {
        const response = await fetch('https://graphql.anilist.co/', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            },
            body: JSON.stringify({ query: query }),
        });

        const result = await response.json();
        const newCharacters = result.data.Page.characters.filter(character => character.gender === 'Female');

        characters = characters.concat(newCharacters);
        totalCharactersFetched += newCharacters.length;
        currentPage++;

        // Break if we've reached the desired number of characters or there are no more characters
        if (totalCharactersFetched >= desiredCharacterCount || newCharacters.length === 0) {
            break; 
        }

        } catch (error) {
        console.error('Error fetching characters:', error);
        break;
        }
    }
    
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));  

        [array[i], array[j]] = [array[j], array[i]]; // Swap elements
      }
    }

    shuffleArray(characters);


    survivors = [...characters];
    updateStatus();
    startDuel();
    }

    // ... (rest of the code remains the same)

    function updateStatus() {
      const statusElement = document.getElementById('status');
      statusElement.innerHTML = `<h2>Round: ${round}</h2><p>Characters left: ${survivors.length}</p>`;
    }

    let duelsPerRound = 0; // Track the number of duels in the current round

    function startDuel() {
    if (survivors.length <= 1) {
        showFinalBoard();
        return;
    }

    if (duelsPerRound === 0) { 
        // Start of a new round, calculate the number of duels
        duelsPerRound = survivors.length / 2; 
    }

    const duelContainer = document.getElementById('duel-container');
    duelContainer.innerHTML = '';

    const char1 = survivors.shift();
    const char2 = survivors.shift();

    currentDuel = [char1, char2];

    displayCharacter(char1, duelContainer);
    displayCharacter(char2, duelContainer);

    duelsPerRound--; // Decrement the number of duels left in this round

    if (duelsPerRound === 0) {
        // All duels for this round are done, move to the next round
        round++;
    }

    updateStatus();
    }

    function displayCharacter(character, container) {
      const card = document.createElement('div');
      card.className = 'character-card';
      card.innerHTML = `
        <h2>${character.name.full}</h2>
        <img src="${character.image.large}" alt="${character.name.full}">
      `;
      container.appendChild(card);
    }

    let eliminationRounds = []; // Track the round in which each character was eliminated

    function selectWinner(winner, loser) {
    survivors.push(winner);
    eliminationRounds[characters.indexOf(loser)] = round; // Record the loser's elimination round

    if (survivors.length === 2) {
        round++;
    }
    startDuel();
    }

    // Handle key press for left and right arrows
    document.addEventListener('keydown', function(event) {
      if (event.key === 'ArrowLeft') {
        // Left arrow key selects the first character
        selectWinner(currentDuel[0], currentDuel[1]);
      } else if (event.key === 'ArrowRight') {
        // Right arrow key selects the second character
        selectWinner(currentDuel[1], currentDuel[0]);
      }
    });

    function showFinalBoard() {
        const finalBoard = document.getElementById('final-board');
        finalBoard.innerHTML = `<h2>Final Winner: ${survivors[0].name.full}</h2>`;
        finalBoard.innerHTML += `<img src="${survivors[0].image.large}" alt="${survivors[0].name.full}">`;

        // Display who survived the longest, sorted by elimination order (most recent losers first)
        let board = '<h3>Survival Board</h3><ol>'; // Use <ol> for numbered list
        let rank = 1; // Initialize rank counter

        characters.sort((a, b) => {
            const aEliminated = !survivors.includes(a);
            const bEliminated = !survivors.includes(b);

            if (aEliminated && !bEliminated) return -1; 
            if (!aEliminated && bEliminated) return 1; 

            if (aEliminated && bEliminated) {
            return eliminationRounds[characters.indexOf(b)] - eliminationRounds[characters.indexOf(a)]; 
            }

            return 0; 
        }).forEach(character => {
            board += `<li>${character.name.full} - ${survivors.includes(character) ? 'Survived' : 'Eliminated'}</li>`;
            rank++; // Increment rank for each character
        });

        board += '</ol>';
        finalBoard.innerHTML += board;
    }
  </script>

</body>
</html>
